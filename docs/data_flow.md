# GuardianAI データフロー詳細図

## 1. ユーザー認証フロー

```
+-------------+     +----------------+     +----------------+     +----------------+
|             |     |                |     |                |     |                |
| ユーザー     | --> | MetaMask SDK   | --> | 署名要求生成    | --> | 署名検証       |
|             |     | 接続要求       |     |                |     |                |
+-------------+     +----------------+     +----------------+     +----------------+
                                                                         |
                                                                         v
                                                               +----------------+
                                                               |                |
                                                               | セッション保存   |
                                                               |                |
                                                               +----------------+
```

## 2. 意図設定フロー

```
+-------------+     +----------------+     +----------------+     +----------------+
|             |     |                |     |                |     |                |
| ユーザー     | --> | 自然言語       | --> | 言語モデル     | --> | 構造化ルール   |
| 意図入力     |     | インターフェース|     | 解析処理       |     | 変換          |
+-------------+     +----------------+     +----------------+     +----------------+
                                                                         |
                                                                         v
                                                               +----------------+
                                                               |                |
                                                               | ローカル保存    |
                                                               |                |
                                                               +----------------+
```

## 3. トランザクション監視フロー

```
+----------------+     +----------------+     +----------------+     +----------------+
|                |     |                |     |                |     |                |
| MetaMask SDK   | --> | トランザクション| --> | ユーザー意図   | --> | 判定エンジン   |
| イベントリスナー|     | データ取得     |     | ルール取得     |     |                |
+----------------+     +----------------+     +----------------+     +----------------+
                                                                         |
                                                                         v
                                              +----------------+     +----------------+
                                              |                |     |                |
                                              | アラート       | <-- | 判定結果       |
                                              | (必要な場合)   |     | (承認/警告)    |
                                              +----------------+     +----------------+
```

## 4. アラートフロー

```
+----------------+     +----------------+     +----------------+     +----------------+
|                |     |                |     |                |     |                |
| 想定外         | --> | アラート       | --> | 通知表示       | --> | ユーザー確認   |
| トランザクション|     | レベル判定     |     | 音声再生       |     | インターフェース|
+----------------+     +----------------+     +----------------+     +----------------+
                                                                         |
                                                                         v
                                              +----------------+     +----------------+
                                              |                |     |                |
                                              | トランザクション| <-- | ユーザー決定   |
                                              | 処理           |     | (承認/拒否)    |
                                              +----------------+     +----------------+
```

## 5. トークン評価フロー

```
+----------------+     +----------------+     +----------------+     +----------------+
|                |     |                |     |                |     |                |
| トークン       | --> | トークン       | --> | 言語モデル     | --> | 評価結果      |
| データ取得     |     | 情報解析       |     | 評価処理       |     | 生成          |
+----------------+     +----------------+     +----------------+     +----------------+
                                                                         |
                                                                         v
                                                               +----------------+
                                                               |                |
                                                               | ユーザー表示    |
                                                               |                |
                                                               +----------------+
```

## 6. P2P通信フロー

```
+----------------+     +----------------+     +----------------+     +----------------+
|                |     |                |     |                |     |                |
| WebRTC         | --> | ピア検出       | --> | 接続確立       | --> | データ交換     |
| 初期化         |     | (DHT利用)      |     |                |     |                |
+----------------+     +----------------+     +----------------+     +----------------+
                                                                         |
                                                                         v
                                                               +----------------+
                                                               |                |
                                                               | 同期処理       |
                                                               |                |
                                                               +----------------+
```

## コンポーネント間データ連携

```
+----------------+                      +----------------+
|                |                      |                |
| UI レイヤー     | <-----------------> | MetaMask SDK   |
|                |                      | 統合モジュール  |
+----------------+                      +----------------+
        ^                                      ^
        |                                      |
        v                                      v
+----------------+                      +----------------+
|                |                      |                |
| 言語モデル     | <-----------------> | トランザクション|
| 統合           |                      | 監視サービス   |
+----------------+                      +----------------+
        ^                                      ^
        |                                      |
        v                                      v
+----------------+                      +----------------+
|                |                      |                |
| アラート       | <-----------------> | P2P通信        |
| システム       |                      | モジュール     |
+----------------+                      +----------------+
```

## オフチェーン処理詳細

1. **ローカルデータ処理**:
   - ユーザー設定、意図ルール、トランザクション履歴はすべてローカルストレージに保存
   - IndexedDB/AsyncStorageを使用して構造化データを管理
   - 暗号化ライブラリを使用してセンシティブデータを保護

2. **AI処理の最適化**:
   - 可能な限りクライアントサイドでAI処理を実行
   - 軽量モデルをローカルにキャッシュ
   - 複雑な処理のみクラウドAPIを利用（APIキーはMetaMaskで保護）

3. **トランザクション検証**:
   - トランザクションデータをローカルで解析
   - ユーザー定義ルールとの照合をクライアントで実行
   - 承認/拒否の判断をローカルで処理

4. **P2P同期メカニズム**:
   - 分散ハッシュテーブルを使用したピア検出
   - WebRTCによるピア間直接通信
   - 差分同期アルゴリズムによる効率的なデータ交換
